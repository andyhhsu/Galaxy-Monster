<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galaxy æ€ªç‰© - äº’å‹•å•ç­”æŒ‘æˆ°è³½</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ Tone.js éŸ³æ•ˆå‡½å¼åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-925KTHYCQE"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-925KTHYCQE');
    </script>

    <style>
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #1a1a2b;
            color: #ffffff;
            user-select: none;
            -webkit-user-select: none;
        }
        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        .screen {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            justify-content: center; /* Reverted for centering */
            align-items: center;
            padding: 1rem;
            box-sizing: border-box;
            position: absolute;
            top: 0;
            left: 0;
            transition: opacity 0.5s ease-in-out;
            animation: fadeIn 0.5s;
            overflow-y: auto; /* Allow scrolling if content overflows */
        }
        .screen-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            max-width: 1024px;
            /* min-height: 100%; Removed to allow natural height */
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        /* Special handling for rules screen to ensure top is visible when scrolling */
        #rules-screen .screen-content {
             justify-content: flex-start;
             padding-top: 4rem; /* Ensure space for header */
        }
        .screen.active {
            display: flex;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 10px rgba(195, 146, 255, 0.4), 0 0 20px rgba(195, 146, 255, 0.3);
            }
            50% {
                box-shadow: 0 0 20px rgba(195, 146, 255, 0.7), 0 0 40px rgba(195, 146, 255, 0.5);
            }
        }
        .btn-primary {
            background: linear-gradient(135deg, #8A2BE2, #4B0082);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(138, 43, 226, 0.4);
            animation: pulse 2.5s infinite;
        }
        .btn-primary:hover {
            transform: translateY(-3px);
            animation-play-state: paused;
            box-shadow: 0 6px 20px rgba(138, 43, 226, 0.6);
        }
        .btn-primary:disabled {
            background: #5a5a7a;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
            animation: none;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
        }
        .timer-bar {
            height: 8px;
            background: linear-gradient(90deg, #8A2BE2, #4B0082);
            transition: width 0.1s linear;
        }
        @keyframes countdown-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .timer-danger {
            color: #dc3545;
            animation: countdown-pulse 1s infinite;
        }
        .option-btn {
            transition: all 0.2s ease;
        }
        .option-btn.correct {
            background-color: #28a745 !important;
            border-color: #28a745 !important;
            transform: scale(1.05);
        }
        .option-btn.wrong {
            background-color: #dc3545 !important;
            border-color: #dc3545 !important;
            opacity: 0.7;
        }
        .option-btn.disabled {
            pointer-events: none;
        }
        .leaderboard-item {
            display: grid;
            grid-template-columns: 1fr 4fr 2fr 1fr;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }
        .highlight-me {
            background-color: rgba(138, 43, 226, 0.3);
            border-left: 4px solid #c392ff;
            transform: scale(1.02);
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body class="w-full h-screen flex justify-center items-center">

    <canvas id="bg-canvas"></canvas>

    <!-- Start Screen -->
    <div id="start-screen" class="screen active">
        <div class="screen-content text-center">

            <h1 class="text-5xl sm:text-6xl md:text-8xl font-black tracking-wider" style="color: #c392ff;">GALAXY æ€ªç‰©</h1>
            <p class="text-xl sm:text-2xl md:text-3xl mt-4 text-gray-300">æŒ‘æˆ°ä½ çš„ Galaxy çŸ¥è­˜é­‚ï¼</p>

            <button id="start-btn" class="btn-primary text-white font-bold py-3 px-10 sm:py-4 sm:px-12 text-xl sm:text-2xl rounded-full mt-12">é–‹å§‹æŒ‘æˆ°</button>

            <div id="top-players-container" class="glass-card w-full max-w-md p-4 my-8 opacity-0 transition-opacity duration-1000">
                <div id="top-players-list" class="space-y-1">
                    <!-- Top players will be inserted here by JavaScript -->
                </div>
            </div>

            <button id="leaderboard-btn" class="block mx-auto text-lg sm:text-xl text-gray-400 hover:text-white transition">æŸ¥çœ‹å®Œæ•´æ’è¡Œæ¦œ</button>
        </div>
    </div>

    <!-- Rules Screen -->
    <div id="rules-screen" class="screen">
        <div class="screen-content pt-12 pb-8">
            <div class="glass-card p-6 sm:p-8 md:p-12 text-center w-full max-w-2xl">
                <h2 class="text-3xl sm:text-4xl font-bold mb-8">éŠæˆ²è¦å‰‡</h2>

                <div class="space-y-6 text-left">
                    <div class="flex items-center space-x-4">
                        <div class="glass-card p-3 rounded-xl"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg></div>
                        <div>
                            <h3 class="font-bold text-lg sm:text-xl">10é“çŸ¥è­˜å•ç­”</h3>
                            <p class="text-gray-300 text-sm sm:text-base">æŒ‘æˆ°é—œæ–¼ä¸‰æ˜Ÿ Galaxy çš„ç²¾å½©é¡Œç›®ã€‚</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="glass-card p-3 rounded-xl"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg></div>
                        <div>
                            <h3 class="font-bold text-lg sm:text-xl">20ç§’æ¥µé€Ÿæ¶ç­”</h3>
                            <p class="text-gray-300 text-sm sm:text-base">é€Ÿåº¦èˆ‡æº–ç¢ºç‡éƒ½æœƒå½±éŸ¿ä½ çš„åˆ†æ•¸ï¼</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                         <div class="glass-card p-3 rounded-xl"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 15h1.5a2.5 2.5 0 0 1 0 5H4"></path><path d="M18 15h1.5a2.5 2.5 0 0 0 0 5H18"></path><line x1="12" y1="9" x2="12" y2="21"></line><line x1="9" y1="12" x2="15" y2="12"></line></svg></div>
                        <div>
                            <h3 class="font-bold text-lg sm:text-xl">ç¸½è€—æ™‚æ±ºå‹</h3>
                            <p class="text-gray-300 text-sm sm:text-base">åŒåˆ†æ™‚ï¼Œå®ŒæˆæŒ‘æˆ°çš„ç¸½æ™‚é–“è¶ŠçŸ­ï¼Œæ’åè¶Šé«˜ã€‚</p>
                        </div>
                    </div>
                </div>

                <div class="mt-8 text-left w-full glass-card p-4 rounded-xl">
                    <h3 class="text-2xl font-bold text-yellow-300 mb-4 text-center">æ´»å‹•çå‹µ</h3>
                    <img src="https://raw.githubusercontent.com/andyhhsu/Galaxy-Monster/main/prize2.png"
                         alt="æ´»å‹•çå“åœ–ç‰‡"
                         class="w-full max-w-sm mx-auto my-4 rounded-lg"
                         onerror="this.onerror=null; this.src='https://placehold.co/400x300/333/ccc?text=Prize+Image+Error'">

                    <p class="text-lg text-center mt-2">ğŸ† <span class="font-bold">åƒåŠ çï¼š</span>ç™»éŒ„æˆç¸¾å³å¯æŠ½ 10,000mAh è¡Œå‹•é›»æºã€‚</p>
                </div>

                <button id="play-btn" class="btn-primary text-white font-bold py-3 px-10 text-lg sm:text-xl rounded-full mt-10">æˆ‘æº–å‚™å¥½äº†ï¼</button>
            </div>
        </div>
    </div>

    <!-- Quiz Screen -->
    <div id="quiz-screen" class="screen">
        <div class="screen-content w-full max-w-4xl">
            <div class="w-full">
                <div class="flex justify-between items-center mb-4">
                    <div id="question-counter" class="text-xl sm:text-2xl font-bold">Q1 / 10</div>
                    <div id="timer" class="text-xl sm:text-2xl font-bold">20</div>
                </div>
                <div class="w-full bg-gray-700 rounded-full mb-6">
                    <div id="timer-bar" class="timer-bar rounded-full"></div>
                </div>
                <div class="glass-card p-6 sm:p-8 mb-8 min-h-[150px] flex items-center justify-center">
                    <h2 id="question-text" class="text-2xl sm:text-3xl md:text-4xl text-center font-bold">å•é¡Œæ–‡å­—è¼‰å…¥ä¸­...</h2>
                </div>
                <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
        </div>
    </div>
    <!-- Score Screen -->
    <div id="score-screen" class="screen">
        <div class="screen-content">
            <div class="glass-card p-6 sm:p-8 md:p-12 text-center w-full max-w-2xl">
                <h2 class="text-xl sm:text-2xl text-gray-300">æŒ‘æˆ°å®Œæˆï¼</h2>
                <div class="my-4">
                    <p class="text-6xl sm:text-7xl font-black" id="final-score">0</p>
                    <p class="text-lg sm:text-xl">åˆ†</p>
                </div>
                <div id="badges-container" class="flex justify-center space-x-4 my-6"></div>
                <div class="w-full space-y-4">
                    <input id="nickname-input" type="text" placeholder="è¼¸å…¥ä½ çš„æš±ç¨±" class="w-full bg-transparent border-2 border-gray-500 rounded-lg py-3 px-4 text-white text-center text-lg sm:text-xl focus:border-purple-500 focus:outline-none transition">
                    <div class="relative">
                        <input id="phone-input" type="tel" placeholder="è¼¸å…¥é›»è©±" class="w-full bg-transparent border-2 border-gray-500 rounded-lg py-3 px-4 text-white text-center text-lg sm:text-xl focus:border-purple-500 focus:outline-none transition">
                        <small class="absolute -bottom-5 left-0 right-0 text-gray-400 text-xs">æŠ½10,000mAhè¡Œå‹•é›»æº,2025/12/1æ–¼ç°¡è¨Šé€šçŸ¥å¾—çè€…ï¼</small>
                    </div>
                    <p id="rank-prediction" class="text-yellow-400 h-6"></p>
                    <button id="submit-score-btn" class="w-full btn-primary text-white font-bold py-3 px-10 text-lg sm:text-xl rounded-lg !mt-8">ç™»éŒ„æˆç¸¾</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Leaderboard Screen, Modals etc. -->
    <div id="leaderboard-screen" class="screen">
        <div class="screen-content">
            <div class="w-full max-w-4xl glass-card">
                <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                    <h2 class="text-3xl sm:text-4xl font-bold">å³æ™‚æ’è¡Œæ¦œ</h2>
                    <button id="close-leaderboard-btn" class="text-4xl font-light text-gray-400 hover:text-white">&times;</button>
                </div>
                <div class="leaderboard-item text-base sm:text-lg font-bold text-gray-400 !grid-cols-[1fr,4fr,2fr,1fr]">
                    <span>æ’å</span>
                    <span>æš±ç¨±</span>
                    <span class="text-right">åˆ†æ•¸</span>
                    <span></span>
                </div>
                <div id="leaderboard-list" class="h-[60vh] overflow-y-auto">
                     <div id="leaderboard-message" class="p-8 text-center text-gray-400 text-lg sm:text-xl">æ’è¡Œæ¦œè¼‰å…¥ä¸­...</div>
                </div>
            </div>
        </div>
    </div>
    <div id="thank-you-screen" class="screen"></div>
    <div id="replay-modal" class="modal-overlay">
        <div class="glass-card p-8 text-center">
            <h3 class="text-2xl font-bold mb-6">æœ€å¼·æ€ªç‰©æ›ä½ ç•¶ï¼<br>è¦ä¸è¦å†ä¾†ä¸€å ´ï¼Ÿ</h3>
            <div class="flex justify-center space-x-4">
                <button id="replay-btn" class="btn-primary text-white font-bold py-2 px-6 rounded-lg">å†æŒ‘æˆ°ä¸€æ¬¡</button>
                <button id="back-to-home-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg">è¿”å›é¦–é </button>
            </div>
        </div>
    </div>
    <div id="share-modal" class="modal-overlay">
        <div class="glass-card p-8 text-center max-w-sm w-full">
            <h3 class="text-2xl font-bold mb-4">åˆ†äº«æˆ‘çš„æˆ°ç¸¾</h3>
            <p class="text-gray-300 mb-4">è¤‡è£½ä»¥ä¸‹æ–‡å­—ï¼Œåˆ°ç¤¾ç¾¤åª’é«”ä¸ŠæŒ‘æˆ°æœ‹å‹å§ï¼</p>
            <textarea id="share-text" class="w-full bg-gray-800 text-white p-2 rounded-lg h-32" readonly></textarea>
            <div class="flex justify-center space-x-4 mt-4">
                <button id="copy-share-text-btn" class="btn-primary text-white font-bold py-2 px-6 rounded-lg">è¤‡è£½æ–‡å­—</button>
                <button id="close-share-modal-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAnalytics, logEvent } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-analytics.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, limit, getDocs } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBZ2uya0Tjog4blOdKv7evLWL1dB4zs3A4",
          authDomain: "galaxy-monster-quiz.firebaseapp.com",
          projectId: "galaxy-monster-quiz",
          storageBucket: "galaxy-monster-quiz.appspot.com",
          messagingSenderId: "255266989387",
          appId: "1:255266989387:web:8083b19e62f5fb589234ce",
          measurementId: "G-925KTHYCQE"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);
        const leaderboardRef = collection(db, "leaderboard");

        const questions = [
            { question: "ä½ åœ¨æ»‘ IG æ™‚çœ‹åˆ°ä¸€é›™è¶…æƒ³è¦çš„çƒé‹ï¼Œä½†ä¸çŸ¥é“å‹è™Ÿï¼é€™æ™‚ Galaxy AI çš„å“ªå€‹åŠŸèƒ½ï¼Œèƒ½è®“ä½ ç”¨æ‰‹æŒ‡ã€Œåœˆä¸€ä¸‹ã€å°±ç«‹åˆ»æ‰¾åˆ°å®ƒï¼Ÿ", options: ["èªéŸ³ç¿»è­¯", "ç”Ÿæˆå¼ç›¸ç‰‡ç·¨è¼¯", "æ™ºæ…§æ‘˜è¦", "æœå°‹åœˆ (Circle to Search)"], answer: 3 },
            { question: "èšé¤æ‹äº†å¼µå®Œç¾çš„åœ˜é«”ç…§ï¼Œæœ‹å‹å€‘éƒ½ä¼¸æ‰‹è¦ç…§ç‰‡ã€‚é€™æ™‚ç”¨å“ªå€‹ Galaxy å…§å»ºåŠŸèƒ½ï¼Œå¯ä»¥åƒéš”ç©ºæŠ•é€ä¸€æ¨£ï¼Œç¬é–“æŠŠåŸåœ–å‚³çµ¦æ‰€æœ‰äººçš„ä¸‰æ˜Ÿè£ç½®ï¼Ÿ", options: ["SmartThings", "å¿«é€Ÿåˆ†äº« (Quick Share)", "Samsung DeX", "Bixby"], answer: 1 },
            { question: "ä½ æ˜¯å€‹æ™‚é–“ç®¡ç†å¤§å¸«ï¼Œç”¨ Galaxy Z Fold å…§é å¤§è¢å¹•ï¼Œä¸€é‚Šçœ‹çƒè³½ç›´æ’­ã€ä¸€é‚Šè·Ÿæœ‹å‹èŠ LINEã€‚è«‹å•ä½ æœ€å¤šé‚„å¯ä»¥å†é–‹å¹¾å€‹ App è¦–çª—ï¼Œé”æˆçµ‚æ¥µçš„ä¸€å¿ƒä¸‰ç”¨ï¼Ÿ", options: ["ä¸€å€‹", "å…©å€‹", "ä¸‰å€‹", "å››å€‹"], answer: 2 },
            { question: "ä½ çš„ Galaxy Watch å°±åƒæ‰‹è…•ä¸Šçš„å¥åº·æ•™ç·´ï¼Œå¯ä»¥åµæ¸¬å¿ƒç‡ã€è¡€æ°§ã€ç”šè‡³èº«é«”çµ„æˆã€‚ä½†ä»¥ç›®å‰çš„ç§‘æŠ€ï¼Œå®ƒé‚„ç„¡æ³•åµæ¸¬ä¸‹åˆ—å“ªä¸€é …æ•¸æ“šï¼Ÿ", options: ["èº«é«”çµ„æˆ (BIA)", "å¿ƒé›»åœ– (ECG)", "è¡€ç³–æ¿ƒåº¦", "è¡€æ°§é£½å’Œåº¦ (SpO2)"], answer: 2 },
            { question: "ä½ æ—©ä¸Šè¶•è‘—ä¸Šç­å¿˜äº†å¸¶è­˜åˆ¥è­‰ï¼Œä¸‹ç­å¾Œåˆè¦æ­æ·é‹æ‰ç™¼ç¾éŒ¢åŒ…ä¹Ÿæ²’å¸¶ï¼é‚„å¥½ï¼ŒSamsung Wallet çš„å“ªå€‹åŠŸèƒ½ï¼Œå¯ä»¥è®“ä½ ç”¨æ‰‹æ©Ÿä¸€æ¬¡æå®šé€™å…©å€‹çª˜å¢ƒï¼Ÿ", options: ["æ•´åˆé›»å­ç™¼ç¥¨è¼‰å…·", "æ‚ éŠå¡èˆ‡é–€ç¦å¡", "ç·šä¸Šè³¼ç‰©ç¶²ç«™æ”¯ä»˜", "å„²å­˜æ•¸ä½æœƒå“¡å¡"], answer: 1 },
            { question: "ä½ å»çœ‹æ¼”å”±æœƒï¼Œé›–ç„¶ååœ¨ã€Œè›‹é ‚ã€ï¼Œä½†é‚„æ˜¯æƒ³æ‹åˆ°å¶åƒè‡‰ä¸Šçš„æ±—ç ï¼é€™æ™‚ Galaxy S æ——è‰¦ç³»åˆ—çš„ã€ŒAI è®Šç„¦ã€æœ€é å¯ä»¥æ‹‰åˆ°å¹¾å€ï¼Œè®“ä½ å½·å½¿ååœ¨ç¬¬ä¸€æ’ï¼Ÿ", options: ["30å€", "50å€", "100å€", "200å€"], answer: 2 },
            { question: "å•Šï¼æ‰‹æ©Ÿä¸å°å¿ƒæ‰é€²æ¸¸æ³³æ± äº†ï¼é‚„å¥½ Galaxy æ——è‰¦æ©Ÿæœ‰ IP68 é˜²æ°´ç­‰ç´šï¼Œå…¶ä¸­ '8' ä»£è¡¨å®ƒå¯ä»¥åœ¨ 1.5 å…¬å°ºçš„æ°´æ·±ä¸‹ï¼Œå®‰å…¨å¾…ä¸Šå¹¾åˆ†é˜ï¼Ÿ", options: ["10 åˆ†é˜", "20 åˆ†é˜", "30 åˆ†é˜", "60 åˆ†é˜"], answer: 2 },
            { question: "ä½ æ˜¯å€‹æ‰‹æ©Ÿè—è¡“å®¶ï¼Œä¸æ»¿è¶³æ–¼é è¨­ä¸»é¡Œï¼Œæƒ³æŠŠé–å®šç•«é¢çš„æ™‚é˜ã€App åˆ‡æ›çš„å‹•ç•«éƒ½æ”¹æˆè‡ªå·±å–œæ­¡çš„æ¨£å­ã€‚ä¸‰æ˜Ÿå®˜æ–¹ç‚ºä½ æº–å‚™äº†å“ªå€‹ã€Œç¥ç´šç¾åŒ– Appã€ï¼Ÿ", options: ["Galaxy Labs", "Good Lock", "Theme Park", "Expert RAW"], answer: 1 },
            { question: "ä¾†å€‹å“ç‰Œå†·çŸ¥è­˜ï¼'Samsung' (ä¸‰æ˜Ÿ) é€™å€‹åå­—åœ¨éŸ“æ–‡ä¸­çš„æ„æ€æ˜¯ä»€éº¼ï¼Œè±¡å¾µè‘—å®å¤§ã€å¼·å¤§èˆ‡æ°¸æ†ï¼Ÿ", options: ["ç§‘æŠ€ä¹‹æ˜Ÿ", "ä¸‰é¡†æ˜Ÿæ˜Ÿ", "æœªæ¥ä¹‹æ˜Ÿ", "äºæ´²ä¹‹æ˜Ÿ"], answer: 1 },
            { question: "ç‚ºäº†å¹«åŠ©æµ·æ´‹æ›´ä¹¾æ·¨ï¼Œä¸‰æ˜Ÿçš„ã€ŒGalaxy for the Planetã€è¨ˆç•«ï¼Œå¾ˆé…·åœ°å°‡å›æ”¶ä¾†çš„ä»€éº¼æ±è¥¿ï¼Œå†è£½æˆæ‰‹æ©Ÿçš„éƒ¨åˆ†é›¶ä»¶ï¼Ÿ", options: ["å›æ”¶å¯¶ç‰¹ç“¶", "å»¢æ£„æ¼ç¶²", "èˆŠå ±ç´™", "äºŒæ‰‹è¼ªèƒ"], answer: 1 }
        ];
        
        const QUESTION_TIME_LIMIT = 20;

        let currentQuestionIndex = 0;
        let score = 0;
        let timerInterval;
        let timeLeft = QUESTION_TIME_LIMIT;
        let currentPlayerDocId = null;
        let idleTimer;
        let startTime; 
        let totalTime;
        let correctAnswers = 0;
        let replayModalTimeout;

        const replayModal = document.getElementById('replay-modal');
        const replayBtn = document.getElementById('replay-btn');
        const backToHomeBtn = document.getElementById('back-to-home-btn');
        const shareModal = document.getElementById('share-modal');
        const closeShareModalBtn = document.getElementById('close-share-modal-btn');
        const copyShareTextBtn = document.getElementById('copy-share-text-btn');
        const screens = { start: document.getElementById('start-screen'), rules: document.getElementById('rules-screen'), quiz: document.getElementById('quiz-screen'), score: document.getElementById('score-screen'), leaderboard: document.getElementById('leaderboard-screen'), thankYou: document.getElementById('thank-you-screen') };
        const startBtn = document.getElementById('start-btn');
        const playBtn = document.getElementById('play-btn');
        const submitScoreBtn = document.getElementById('submit-score-btn');
        const nicknameInput = document.getElementById('nickname-input');
        const phoneInput = document.getElementById('phone-input');
        const leaderboardBtn = document.getElementById('leaderboard-btn');
        const closeLeaderboardBtn = document.getElementById('close-leaderboard-btn');
        
        const sounds = {
            correct: new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.2 } }).toDestination(),
            wrong: new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0.1, release: 0.3 } }).toDestination(),
            click: new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 2, envelope: { attack: 0.001, decay: 0.2, sustain: 0 } }).toDestination(),
            countdown: new Tone.Synth({ oscillator: { type: "triangle" }, volume: -10, envelope: { attack: 0.01, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination(),
            scoreCount: new Tone.Synth({ oscillator: { type: "sawtooth" }, volume: -15, envelope: { attack: 0.01, decay: 0.05, sustain: 0, release: 0.1 } }).toDestination(),
            scoreFinal: new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.5, sustain: 0.2, release: 0.5 } }).toDestination(),
            achievement: new Tone.PolySynth(Tone.Synth, { envelope: { attack: 0.01 } }).toDestination()
        };

        function playSound(sound, note) {
            // **FIX: Only play sound if page is visible**
            if (document.visibilityState === 'hidden' || Tone.context.state !== 'running') return;
            switch (sound) {
                case 'correct': sounds.correct.triggerAttackRelease("C5", "8n", Tone.now()); sounds.correct.triggerAttackRelease("G5", "8n", Tone.now() + 0.1); break;
                case 'wrong': sounds.wrong.triggerAttackRelease("C3", "4n"); break;
                case 'click': sounds.click.triggerAttackRelease("C2", "8n"); break;
                case 'countdown': sounds.countdown.triggerAttackRelease("G2", "16n"); break;
                case 'scoreCount': sounds.scoreCount.triggerAttackRelease(note, "32n"); break;
                case 'scoreFinal': sounds.scoreFinal.triggerAttackRelease("C6", "4n"); break;
                case 'achievement': sounds.achievement.triggerAttackRelease(["C5", "E5", "G5"], "8n"); break;
            }
        }
        
        function resetIdleTimer() { clearTimeout(idleTimer); if (!screens.start.classList.contains('active')) { idleTimer = setTimeout(() => { switchScreen('start'); }, 30000); } }
        function switchScreen(screenName) { Object.values(screens).forEach(screen => screen.classList.remove('active')); screens[screenName].classList.add('active'); resetIdleTimer(); }
        
        function startGame() {
            logEvent(analytics, 'game_start');
            startTime = performance.now();
            currentQuestionIndex = 0;
            score = 0;
            correctAnswers = 0;
            currentPlayerDocId = null;
            showQuestion();
            switchScreen('quiz');
        }

        function showQuestion() {
            if (currentQuestionIndex >= questions.length) { endGame(); return; }
            const questionData = questions[currentQuestionIndex];
            document.getElementById('question-counter').textContent = `Q${currentQuestionIndex + 1} / ${questions.length}`;
            document.getElementById('question-text').textContent = questionData.question;
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            questionData.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('option-btn', 'w-full', 'glass-card', 'p-4', 'text-lg', 'sm:text-xl', 'text-left', 'border-2', 'border-gray-600', 'hover:bg-purple-700', 'hover:border-purple-500');
                button.onclick = () => { playSound('click'); selectAnswer(index, questionData.answer); };
                optionsContainer.appendChild(button);
            });
            startTimer();
        }

        function startTimer() {
            const timerEl = document.getElementById('timer');
            const timerBar = document.getElementById('timer-bar');
            timerEl.classList.remove('timer-danger');
            timeLeft = QUESTION_TIME_LIMIT;
            timerEl.textContent = timeLeft;
            timerBar.style.width = '100%';
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft -= 0.1;
                timerBar.style.width = `${(timeLeft / QUESTION_TIME_LIMIT) * 100}%`;
                const roundedTime = Math.ceil(timeLeft);
                if (parseInt(timerEl.textContent) !== roundedTime) {
                     timerEl.textContent = roundedTime;
                     if (roundedTime <= 5) {
                        timerEl.classList.add('timer-danger');
                        playSound('countdown'); // Play sound only if visible (checked in playSound)
                     }
                }
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    selectAnswer(-1, questions[currentQuestionIndex].answer);
                }
            }, 100);
        }

        function selectAnswer(selectedIndex, correctIndex) {
            clearInterval(timerInterval);
            const options = document.querySelectorAll('.option-btn');
            options.forEach(btn => btn.classList.add('disabled'));
            if (selectedIndex === correctIndex) {
                playSound('correct');
                score += 1000 + Math.floor(timeLeft * (1000 / QUESTION_TIME_LIMIT));
                correctAnswers++;
                options[selectedIndex].classList.add('correct');
            } else {
                playSound('wrong');
                if (selectedIndex !== -1) options[selectedIndex].classList.add('wrong');
                options[correctIndex].classList.add('correct');
            }
            setTimeout(() => {
                currentQuestionIndex++;
                showQuestion();
            }, 1500);
        }

        function endGame() {
            const endTime = performance.now();
            totalTime = (endTime - startTime) / 1000;
            switchScreen('score');
            animateScore(score);
            showBadges();
            getRankPrediction(score, totalTime);
        }

        async function saveScore() {
            const nickname = nicknameInput.value.trim();
            const phone = phoneInput.value.trim();
            if (!nickname || !phone) { alert('è«‹å‹™å¿…å¡«å¯«æš±ç¨±å’Œé›»è©±ï¼'); return; }
            submitScoreBtn.disabled = true;
            submitScoreBtn.textContent = 'ä¸Šå‚³ä¸­...';
            try {
                logEvent(analytics, 'submit_score', { value: score, player_nickname: nickname });
                const docRef = await addDoc(leaderboardRef, {
                    nickname: nickname,
                    phone: phone,
                    score: score,
                    totalTime: totalTime,
                    timestamp: serverTimestamp()
                });
                currentPlayerDocId = docRef.id;
                switchScreen('leaderboard');
                nicknameInput.value = '';
                phoneInput.value = '';
                submitScoreBtn.disabled = false;
                submitScoreBtn.textContent = 'ç™»éŒ„æˆç¸¾';
            } catch (error) {
                console.error("å¯«å…¥ Firestore å¤±æ•—:", error);
                alert("æˆç¸¾ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–è¯ç¹«ç®¡ç†å“¡ã€‚");
                submitScoreBtn.disabled = false;
                submitScoreBtn.textContent = 'ç™»éŒ„æˆç¸¾';
            }
        }
        
        function animateScore(finalScore) {
            const scoreEl = document.getElementById('final-score');
            let currentScore = 0;
            const duration = 1500;
            const stepTime = 50;
            const steps = duration / stepTime;
            const increment = finalScore > 0 ? finalScore / steps : 0;
            const notes = ["C4", "D4", "E4", "F4", "G4", "A4", "B4", "C5"];
            let noteIndex = 0;

            const counter = setInterval(() => {
                // **FIX: Check visibility before playing sound**
                if (document.visibilityState === 'visible') {
                    currentScore += increment;
                    if (currentScore >= finalScore) {
                        currentScore = finalScore;
                        clearInterval(counter);
                        playSound('scoreFinal');
                    }
                    scoreEl.textContent = Math.floor(currentScore);
                    playSound('scoreCount', notes[noteIndex % notes.length]);
                    noteIndex++;
                } else {
                    // If page becomes hidden during animation, jump to final score and stop
                    currentScore = finalScore;
                    scoreEl.textContent = Math.floor(currentScore);
                    clearInterval(counter);
                }
            }, stepTime);
        }

        function showBadges() {
            const container = document.getElementById('badges-container');
            container.innerHTML = '';
            let badges = [];
            if (correctAnswers === 10) badges.push({ name: 'ç¥æº–å°„æ‰‹', icon: 'ğŸ¯' });
            if (totalTime < 120) badges.push({ name: 'å…‰é€Ÿå¿«æ‰‹', icon: 'âš¡' }); 
            if (score > 25000) badges.push({ name: 'çŸ¥è­˜æ€ªç‰©', icon: 'ğŸ‘¾' });
            if (badges.length > 0) playSound('achievement');
            badges.forEach(badge => {
                const badgeEl = document.createElement('div');
                badgeEl.className = 'glass-card flex flex-col items-center p-2 rounded-lg';
                badgeEl.innerHTML = `<span class="text-3xl">${badge.icon}</span><span class="text-xs mt-1">${badge.name}</span>`;
                container.appendChild(badgeEl);
            });
        }
        
        async function getRankPrediction(currentScore, currentTime) {
            const predictionEl = document.getElementById('rank-prediction');
            predictionEl.textContent = 'æ­£åœ¨è¨ˆç®—æ’å...';
            try {
                const q = query(leaderboardRef, orderBy("score", "desc"), orderBy("totalTime", "asc"));
                const snapshot = await getDocs(q);
                let rank = 1;
                let positionFound = false;
                snapshot.forEach(doc => {
                    if (positionFound) return;
                    const player = doc.data();
                    if (currentScore > player.score || (currentScore === player.score && currentTime < player.totalTime)) {
                        positionFound = true;
                    } else {
                        rank++;
                    }
                });
                predictionEl.textContent = `é€™å€‹æˆç¸¾å°‡å¯æ’åˆ°ç¬¬ ${rank} åï¼`;
            } catch (e) {
                predictionEl.textContent = '';
            }
        }

        function setupLeaderboardListener() {
            const leaderboardList = document.getElementById('leaderboard-list');
            const leaderboardMessage = document.getElementById('leaderboard-message');
            const topPlayersList = document.getElementById('top-players-list');
            const topPlayersContainer = document.getElementById('top-players-container');
            const q = query(leaderboardRef, orderBy("score", "desc"), orderBy("totalTime", "asc"), limit(20));
            
            let replayTimeout;
            onSnapshot(q, (querySnapshot) => {
                leaderboardList.innerHTML = '';
                topPlayersList.innerHTML = '';
                
                if (querySnapshot.empty) {
                    leaderboardMessage.textContent = 'ç›®å‰é‚„æ²’æœ‰äººæŒ‘æˆ°æˆåŠŸï¼Œå¿«ä¾†æ¶é ­é¦™ï¼';
                    if (leaderboardList && !leaderboardList.contains(leaderboardMessage)) leaderboardList.appendChild(leaderboardMessage);
                    topPlayersContainer.classList.add('opacity-0');
                } else {
                    topPlayersContainer.classList.remove('opacity-0');
                    let playerRank = -1;
                    querySnapshot.docs.forEach((doc, index) => {
                        const player = doc.data();
                        const item = document.createElement('div');
                        item.classList.add('leaderboard-item', 'text-lg', 'sm:text-xl', 'border-t', 'border-gray-700');
                        if (index < 3) item.classList.add('font-bold', 'text-yellow-300');
                        
                        const rankEl = `<span>#${index + 1}</span>`;
                        const nameEl = `<span class="truncate">${player.nickname}</span>`;
                        const scoreEl = `<span class="text-right">${player.score}</span>`;
                        const shareContainer = document.createElement('div');
                        shareContainer.className = "flex justify-center items-center";

                        if (doc.id === currentPlayerDocId) {
                            item.classList.add('highlight-me');
                            playerRank = index + 1;
                            setTimeout(() => item.scrollIntoView({ behavior: 'smooth', block: 'center' }), 500);
                            const shareBtn = document.createElement('button');
                            shareBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>`;
                            shareBtn.className = 'text-gray-400 hover:text-white transition';
                            shareBtn.onclick = (e) => { e.stopPropagation(); playSound('click'); showShareModal(playerRank, player.score); };
                            shareContainer.appendChild(shareBtn);
                        }
                        
                        item.innerHTML = rankEl + nameEl + scoreEl;
                        item.appendChild(shareContainer);
                        leaderboardList.appendChild(item);

                        if (index < 3) {
                            const topPlayerItem = document.createElement('div');
                            topPlayerItem.className = 'flex justify-between items-center text-lg';
                            topPlayerItem.innerHTML = `<span class="font-bold text-yellow-400">#${index + 1} ${player.nickname}</span> <span class="text-gray-300">${player.score}åˆ†</span>`;
                            topPlayersList.appendChild(topPlayerItem);
                        }
                    });
                    
                    if (currentPlayerDocId) {
                        clearTimeout(replayTimeout);
                        replayTimeout = setTimeout(() => {
                            if (screens.leaderboard.classList.contains('active')) {
                                replayModal.classList.add('active');
                                
                                clearTimeout(replayModalTimeout);
                                replayModalTimeout = setTimeout(() => {
                                    if (replayModal.classList.contains('active')) {
                                        replayModal.classList.remove('active');
                                        switchScreen('start');
                                    }
                                }, 15000);
                            }
                        }, 15000);
                    }
                }
            }, (error) => {
                 console.error("ç›£è½æ’è¡Œæ¦œå¤±æ•—:", error);
                 leaderboardList.innerHTML = '';
                 if (leaderboardList && leaderboardMessage) {
                    leaderboardMessage.textContent = 'è®€å–æ’è¡Œæ¦œå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Firestore è¦å‰‡èˆ‡ç¶²è·¯é€£ç·šã€‚';
                    if (!leaderboardList.contains(leaderboardMessage)) leaderboardList.appendChild(leaderboardMessage);
                    if(error.code === 'failed-precondition') {
                        leaderboardMessage.innerHTML += '<br><br><small>æç¤ºï¼šè«‹æŒ‰ F12 æ‰“é–‹é–‹ç™¼è€…å·¥å…·ï¼ŒæŸ¥çœ‹ Console ä¸­çš„éŒ¯èª¤é€£çµä¾†å»ºç«‹ç´¢å¼•ã€‚</small>';
                    }
                 }
            });
        }
        
        function showShareModal(rank, shareScore) {
            const shareText = document.getElementById('share-text');
            shareText.value = `å¤ªç‹‚äº†ï¼æˆ‘åœ¨ä¸‰æ˜Ÿé–€å¸‚çš„ #Galaxyæ€ªç‰© æŒ‘æˆ°è³½æ‹¿åˆ° ${shareScore} åˆ†ï¼Œå…¨åœ‹ç¬¬ ${rank} åï¼å¿«ä¾†æŒ‘æˆ°æˆ‘çš„ç´€éŒ„ï¼ #ä¸‰æ˜Ÿæ™ºæ…§é¤¨`;
            shareModal.classList.add('active');
        }

        async function handleInteraction(callback) {
            if (Tone.context.state !== 'running') await Tone.start();
            playSound('click');
            callback();
        }

        startBtn.onclick = () => handleInteraction(() => { currentPlayerDocId = null; switchScreen('rules'); });
        playBtn.onclick = () => handleInteraction(startGame);
        submitScoreBtn.onclick = () => handleInteraction(saveScore);
        leaderboardBtn.onclick = () => handleInteraction(() => { currentPlayerDocId = null; switchScreen('leaderboard'); });
        closeLeaderboardBtn.onclick = () => handleInteraction(() => { currentPlayerDocId = null; switchScreen('start'); });
        
        replayBtn.onclick = () => { clearTimeout(replayModalTimeout); replayModal.classList.remove('active'); handleInteraction(startGame); };
        backToHomeBtn.onclick = () => { clearTimeout(replayModalTimeout); replayModal.classList.remove('active'); handleInteraction(() => switchScreen('start')); };
        closeShareModalBtn.onclick = () => { playSound('click'); shareModal.classList.remove('active'); };
        copyShareTextBtn.onclick = () => {
            playSound('click');
            const shareText = document.getElementById('share-text');
            shareText.select();
            document.execCommand('copy');
            copyShareTextBtn.textContent = 'å·²è¤‡è£½!';
            setTimeout(() => { copyShareTextBtn.textContent = 'è¤‡è£½æ–‡å­—'; }, 2000);
        };
        
        ['mousedown', 'mousemove', 'touchstart', 'keydown'].forEach(event => document.addEventListener(event, resetIdleTimer, true));

        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        const productShapes = [
            (ctx) => { ctx.moveTo(0, 0); ctx.lineTo(100, 5); ctx.lineTo(95, 0); ctx.closePath(); },
            (ctx) => { ctx.moveTo(0, 0); ctx.lineTo(50, 20); ctx.lineTo(100, 0); ctx.lineTo(100, 10); ctx.lineTo(50, 30); ctx.lineTo(0, 10); ctx.closePath(); },
            (ctx) => { ctx.arc(20, 20, 20, 0, Math.PI * 2); ctx.arc(20, 70, 15, 0, Math.PI * 2); ctx.arc(20, 110, 15, 0, Math.PI * 2); }
        ];

        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }

        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.isShape = Math.random() > 0.9;
                if (this.isShape) {
                    this.shape = productShapes[Math.floor(Math.random() * productShapes.length)];
                    this.scale = Math.random() * 0.2 + 0.15;
                    this.rotation = Math.random() * Math.PI * 2;
                    this.rotationSpeed = (Math.random() - 0.5) * 0.001;
                    this.opacity = Math.random() * 0.2 + 0.1;
                } else {
                    this.size = Math.random() * 1.5 + 0.5;
                    this.opacity = Math.random() * 0.5 + 0.2;
                }
                this.speedX = (Math.random() * 0.3 - 0.15);
                this.speedY = (Math.random() * 0.3 - 0.15);
            }
            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                if (this.isShape) this.rotation += this.rotationSpeed;
                if (this.x > canvas.width + 50) this.x = -50;
                if (this.x < -50) this.x = canvas.width + 50;
                if (this.y > canvas.height + 50) this.y = -50;
                if (this.y < -50) this.y = canvas.height + 50;
            }
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.globalAlpha = this.opacity;
                if (this.isShape) {
                    ctx.rotate(this.rotation);
                    ctx.scale(this.scale, this.scale);
                    ctx.strokeStyle = `rgba(200, 180, 255, 0.7)`;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    this.shape(ctx);
                    ctx.stroke();
                } else {
                    ctx.fillStyle = `rgba(255, 255, 255, 1)`;
                    ctx.beginPath();
                    ctx.arc(0, 0, this.size, 0, Math.PI * 2);
                    ctx.fill();
                }
                ctx.restore();
            }
        }

        function initParticles() {
            particles = [];
            let numberOfParticles = (canvas.width * canvas.height) / 9000;
            for (let i = 0; i < numberOfParticles; i++) {
                particles.push(new Particle());
            }
        }

        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let i = 0; i < particles.length; i++) {
                particles[i].update();
                particles[i].draw();
            }
            requestAnimationFrame(animateParticles);
        }

        window.addEventListener('resize', () => { resizeCanvas(); initParticles(); });

        // **FIX: Add visibility change listener to mute/unmute audio**
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                Tone.Destination.mute = true;
                clearTimeout(timerInterval); // Stop game timer if tab is hidden
                clearTimeout(idleTimer); // Stop idle timer
            } else {
                Tone.Destination.mute = false;
                // Optionally restart timers if needed, depending on desired game behavior
                // For now, simply unmuting is sufficient
                resetIdleTimer(); // Restart idle timer when visible again
            }
        });


        resizeCanvas(); initParticles(); animateParticles();
        setupLeaderboardListener();
        resetIdleTimer();

    </script>
</body>
</html>

