<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galaxy 怪物 - 互動問答挑戰賽</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- 引入 Tone.js 音效函式庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-925KTHYCQE"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-925KTHYCQE');
    </script>

    <style>
        html, body {
            height: 100%;
            overflow: hidden; 
        }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #1a1a2b;
            color: #ffffff;
            user-select: none;
            -webkit-user-select: none;
        }
        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        .screen {
            display: none;
            width: 100%;
            height: 100%; 
            flex-direction: column;
            justify-content: flex-start; 
            align-items: center;
            padding: 2rem;
            box-sizing: border-box;
            position: absolute;
            top: 0;
            left: 0;
            transition: opacity 0.5s ease-in-out;
            animation: fadeIn 0.5s;
            overflow-y: auto; 
        }
        .screen-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            max-width: 1024px; 
            min-height: 100%; 
        }
        .screen.active {
            display: flex;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 10px rgba(195, 146, 255, 0.4), 0 0 20px rgba(195, 146, 255, 0.3);
            }
            50% {
                box-shadow: 0 0 20px rgba(195, 146, 255, 0.7), 0 0 40px rgba(195, 146, 255, 0.5);
            }
        }
        .btn-primary {
            background: linear-gradient(135deg, #8A2BE2, #4B0082);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(138, 43, 226, 0.4);
            animation: pulse 2.5s infinite;
        }
        .btn-primary:hover {
            transform: translateY(-3px);
            animation-play-state: paused;
            box-shadow: 0 6px 20px rgba(138, 43, 226, 0.6);
        }
        .btn-primary:disabled {
            background: #5a5a7a;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
            animation: none;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
        }
        .timer-bar {
            height: 8px;
            background: linear-gradient(90deg, #8A2BE2, #4B0082);
            transition: width 0.1s linear;
        }
        .option-btn {
            transition: all 0.2s ease;
        }
        .option-btn.correct {
            background-color: #28a745 !important;
            border-color: #28a745 !important;
            transform: scale(1.05);
        }
        .option-btn.wrong {
            background-color: #dc3545 !important;
            border-color: #dc3545 !important;
            opacity: 0.7;
        }
        .option-btn.disabled {
            pointer-events: none;
        }
        .leaderboard-item {
            display: grid;
            grid-template-columns: 1fr 4fr 2fr;
            align-items: center;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }
        .highlight-me {
            background-color: rgba(138, 43, 226, 0.3);
            border-left: 4px solid #c392ff;
            transform: scale(1.02);
        }
    </style>
</head>
<body class="w-full h-screen flex justify-center items-center">

    <canvas id="bg-canvas"></canvas>

    <!-- Start Screen -->
    <div id="start-screen" class="screen active">
        <div class="screen-content text-center">
            
            <h1 class="text-5xl sm:text-6xl md:text-8xl font-black tracking-wider" style="color: #c392ff;">GALAXY 怪物</h1>
            <p class="text-xl sm:text-2xl md:text-3xl mt-4 text-gray-300">挑戰你的 Galaxy 知識魂！</p>
            
            <button id="start-btn" class="btn-primary text-white font-bold py-3 px-10 sm:py-4 sm:px-12 text-xl sm:text-2xl rounded-full mt-12">開始挑戰</button>
            
            <div id="top-players-container" class="glass-card w-full max-w-md p-4 my-8 opacity-0 transition-opacity duration-1000">
                <div id="top-players-list" class="space-y-1">
                    <!-- Top players will be inserted here by JavaScript -->
                </div>
            </div>

            <button id="leaderboard-btn" class="block mx-auto text-lg sm:text-xl text-gray-400 hover:text-white transition">查看完整排行榜</button>
        </div>
    </div>
    
    <!-- Rules Screen, Quiz Screen, etc. -->
    <div id="rules-screen" class="screen">
        <div class="screen-content">
            <div class="glass-card p-6 sm:p-8 md:p-12 text-center w-full max-w-2xl">
                <h2 class="text-3xl sm:text-4xl font-bold mb-6">遊戲規則</h2>
                <ul class="text-lg sm:text-xl space-y-4 text-left">
                    <li>✔️ 共 10 道關於三星 Galaxy 的知識問答。</li>
                    <li>⏱️ 每題限時 15 秒，答題速度越快，分數越高！</li>
                    <li>同分時，將以完成挑戰的「總花費時間」較短者排名在前。</li>
                    <li>🏆 挑戰成功後登錄成績，即可抽10,000mAh行動電源。</li>
                </ul>

                <div class="mt-8 text-left w-full">
                    <h3 class="text-2xl font-bold text-yellow-300 mb-4 text-center">排行榜獎勵</h3>
                    <p class="text-lg">🥇 <span class="font-bold">冠軍：</span>20,000mAh行動電源*1</p>
                    <p class="text-lg mt-2">🥈 <span class="font-bold">亞軍：</span>Snapware康寧輕瓷保溫吸管杯*1</p>
                    <p class="text-lg mt-2">🥉 <span class="font-bold">季軍：</span>放鬆筋膜槍*1</p>
                </div>

                <button id="play-btn" class="btn-primary text-white font-bold py-3 px-10 text-lg sm:text-xl rounded-full mt-10">我準備好了！</button>
            </div>
        </div>
    </div>
    <div id="quiz-screen" class="screen">
        <div class="screen-content w-full max-w-4xl">
            <div class="w-full">
                <div class="flex justify-between items-center mb-4">
                    <div id="question-counter" class="text-xl sm:text-2xl font-bold">Q1 / 10</div>
                    <div id="timer" class="text-xl sm:text-2xl font-bold">15</div>
                </div>
                <div class="w-full bg-gray-700 rounded-full mb-6">
                    <div id="timer-bar" class="timer-bar rounded-full"></div>
                </div>
                <div class="glass-card p-6 sm:p-8 mb-8 min-h-[150px] flex items-center justify-center">
                    <h2 id="question-text" class="text-2xl sm:text-3xl md:text-4xl text-center font-bold">問題文字載入中...</h2>
                </div>
                <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
        </div>
    </div>
    <div id="score-screen" class="screen">
        <div class="screen-content">
            <div class="glass-card p-6 sm:p-8 md:p-12 text-center w-full max-w-2xl">
                <h2 class="text-xl sm:text-2xl text-gray-300">挑戰完成！</h2>
                <div class="my-4">
                    <p class="text-6xl sm:text-7xl font-black" id="final-score">0</p>
                    <p class="text-lg sm:text-xl">分</p>
                </div>
                <div class="w-full space-y-4">
                    <input id="nickname-input" type="text" placeholder="輸入你的暱稱" class="w-full bg-transparent border-2 border-gray-500 rounded-lg py-3 px-4 text-white text-center text-lg sm:text-xl focus:border-purple-500 focus:outline-none transition">
                    <div class="relative">
                        <input id="phone-input" type="tel" placeholder="輸入電話" class="w-full bg-transparent border-2 border-gray-500 rounded-lg py-3 px-4 text-white text-center text-lg sm:text-xl focus:border-purple-500 focus:outline-none transition">
                        <small class="absolute -bottom-5 left-0 right-0 text-gray-400 text-xs">抽10,000mAh行動電源,2025/11/1於簡訊通知得獎者！</small>
                    </div>
                    <button id="submit-score-btn" class="w-full btn-primary text-white font-bold py-3 px-10 text-lg sm:text-xl rounded-lg !mt-8">登錄成績</button>
                </div>
            </div>
        </div>
    </div>
    <div id="leaderboard-screen" class="screen">
        <div class="screen-content">
            <div class="w-full max-w-4xl glass-card">
                <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                    <h2 class="text-3xl sm:text-4xl font-bold">即時排行榜</h2>
                    <button id="close-leaderboard-btn" class="text-4xl font-light text-gray-400 hover:text-white">&times;</button>
                </div>
                <div class="leaderboard-item text-base sm:text-lg font-bold text-gray-400">
                    <span>排名</span>
                    <span>暱稱</span>
                    <span class="text-right">分數</span>
                </div>
                <div id="leaderboard-list" class="h-[60vh] overflow-y-auto">
                     <div id="leaderboard-message" class="p-8 text-center text-gray-400 text-lg sm:text-xl">排行榜載入中...</div>
                </div>
            </div>
        </div>
    </div>
    <div id="thank-you-screen" class="screen"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAnalytics, logEvent } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-analytics.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBZ2uya0Tjog4blOdKv7evLWL1dB4zs3A4",
          authDomain: "galaxy-monster-quiz.firebaseapp.com",
          projectId: "galaxy-monster-quiz",
          storageBucket: "galaxy-monster-quiz.appspot.com",
          messagingSenderId: "255266989387",
          appId: "1:255266989387:web:8083b19e62f5fb589234ce",
          measurementId: "G-925KTHYCQE"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);
        const leaderboardRef = collection(db, "leaderboard");

        const questions = [
            { question: "三星最新的 Galaxy AI 功能中，哪一項可以讓你用 S Pen 或手指圈選畫面上任何物件，立即進行網路搜尋？", options: ["語音翻譯", "生成式相片編輯", "智慧摘要", "搜尋圈 (Circle to Search)"], answer: 3 },
            { question: "當你想將 Galaxy 手機中的照片快速傳給朋友的三星平板，應該使用哪個內建功能最方便？", options: ["SmartThings", "快速分享 (Quick Share)", "Samsung DeX", "Bixby"], answer: 1 },
            { question: "Galaxy Z Fold 系列摺疊手機在展開內頁螢幕時，最多可以同時開啟幾個應用程式視窗進行多工處理？", options: ["一個", "兩個", "三個", "四個"], answer: 2 },
            { question: "Galaxy Watch 上的 BioActive 感應器，不包含以下哪一項健康數據偵測？", options: ["身體組成 (BIA)", "心電圖 (ECG)", "血糖濃度", "血氧飽和度 (SpO2)"], answer: 2 },
            { question: "Samsung Wallet (原 Samsung Pay) 除了信用卡支付外，還整合了下列哪項便利功能？", options: ["線上購物", "悠遊卡與門禁卡", "股票下單", "繳納電費"], answer: 1 },
            { question: "Galaxy S 旗艦系列的相機具備強大的「AI 變焦」技術，最高可支援到幾倍的數位變焦來拍攝遠方景物？", options: ["30倍", "50倍", "100倍", "200倍"], answer: 2 },
            { question: "三星的 Galaxy 旗艦手機與手錶通常具備 IP68 防水防塵等級，其中數字 '8' 代表它可以在多深的水下正常運作？", options: ["0.5 公尺", "1 公尺", "1.5 公尺", "3 公尺"], answer: 2 },
            { question: "如果您是一位喜歡高度客製化手機介面的玩家，三星官方推出了哪一款 App，可以讓您自由調整如鎖定畫面、多工處理視窗等各種細節？", options: ["Galaxy Labs", "Good Lock", "Theme Park", "Expert RAW"], answer: 1 },
            { question: "'Samsung' (三星) 這個名字在韓文中的意思是什麼，象徵著宏大、強大與永恆？", options: ["科技之星", "三顆星星", "未来之星", "亞洲之星"], answer: 1 },
            { question: "三星為了永續發展而推動的「Galaxy for the Planet」計畫，使用了下列何種回收材料來製作部分手機元件？", options: ["回收寶特瓶", "廢棄漁網", "舊報紙", "二手輪胎"], answer: 1 }
        ];
        
        let currentQuestionIndex = 0;
        let score = 0;
        let timerInterval;
        let timeLeft = 15;
        let currentPlayerDocId = null;
        let idleTimer;
        let startTime; // 新增：遊戲開始時間
        let totalTime; // 新增：總花費時間

        const screens = { start: document.getElementById('start-screen'), rules: document.getElementById('rules-screen'), quiz: document.getElementById('quiz-screen'), score: document.getElementById('score-screen'), leaderboard: document.getElementById('leaderboard-screen'), thankYou: document.getElementById('thank-you-screen') };
        const startBtn = document.getElementById('start-btn');
        const playBtn = document.getElementById('play-btn');
        const submitScoreBtn = document.getElementById('submit-score-btn');
        const nicknameInput = document.getElementById('nickname-input');
        const phoneInput = document.getElementById('phone-input');
        const leaderboardBtn = document.getElementById('leaderboard-btn');
        const closeLeaderboardBtn = document.getElementById('close-leaderboard-btn');
        
        const sounds = {
            correct: new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.2 } }).toDestination(),
            wrong: new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0.1, release: 0.3 } }).toDestination(),
            click: new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 2, envelope: { attack: 0.001, decay: 0.2, sustain: 0 } }).toDestination()
        };

        function playSound(sound) {
            if (Tone.context.state !== 'running') return;
            switch (sound) {
                case 'correct':
                    sounds.correct.triggerAttackRelease("C5", "8n", Tone.now());
                    sounds.correct.triggerAttackRelease("G5", "8n", Tone.now() + 0.1);
                    break;
                case 'wrong':
                    sounds.wrong.triggerAttackRelease("C3", "4n");
                    break;
                case 'click':
                    sounds.click.triggerAttackRelease("C2", "8n");
                    break;
            }
        }

        function resetIdleTimer() {
            clearTimeout(idleTimer);
            if (!screens.start.classList.contains('active')) {
                idleTimer = setTimeout(() => {
                    switchScreen('start');
                }, 30000);
            }
        }

        function switchScreen(screenName) {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            screens[screenName].classList.add('active');
            resetIdleTimer();
        }

        function startGame() {
            logEvent(analytics, 'game_start');
            startTime = new Date(); // **修改：記錄開始時間**
            currentQuestionIndex = 0;
            score = 0;
            currentPlayerDocId = null;
            showQuestion();
            switchScreen('quiz');
        }

        function showQuestion() {
            if (currentQuestionIndex >= questions.length) {
                endGame();
                return;
            }
            const questionData = questions[currentQuestionIndex];
            document.getElementById('question-counter').textContent = `Q${currentQuestionIndex + 1} / ${questions.length}`;
            document.getElementById('question-text').textContent = questionData.question;
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            questionData.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('option-btn', 'w-full', 'glass-card', 'p-4', 'text-lg', 'sm:text-xl', 'text-left', 'border-2', 'border-gray-600', 'hover:bg-purple-700', 'hover:border-purple-500');
                button.onclick = () => {
                    playSound('click');
                    selectAnswer(index, questionData.answer);
                };
                optionsContainer.appendChild(button);
            });
            startTimer();
        }

        function startTimer() {
            timeLeft = 15;
            document.getElementById('timer').textContent = timeLeft;
            const timerBar = document.getElementById('timer-bar');
            timerBar.style.width = '100%';
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft -= 0.1;
                timerBar.style.width = `${(timeLeft / 15) * 100}%`;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    selectAnswer(-1, questions[currentQuestionIndex].answer);
                }
                document.getElementById('timer').textContent = Math.ceil(timeLeft);
            }, 100);
        }

        function selectAnswer(selectedIndex, correctIndex) {
            clearInterval(timerInterval);
            const options = document.querySelectorAll('.option-btn');
            options.forEach(btn => btn.classList.add('disabled'));
            if (selectedIndex === correctIndex) {
                playSound('correct');
                score += 1000 + Math.floor(timeLeft * 100);
                options[selectedIndex].classList.add('correct');
            } else {
                playSound('wrong');
                if (selectedIndex !== -1) options[selectedIndex].classList.add('wrong');
                options[correctIndex].classList.add('correct');
            }
            setTimeout(() => {
                currentQuestionIndex++;
                showQuestion();
            }, 1500);
        }

        function endGame() {
            const endTime = new Date();
            totalTime = (endTime - startTime) / 1000; // **修改：計算總耗時(秒)**
            document.getElementById('final-score').textContent = score;
            switchScreen('score');
        }

        async function saveScore() {
            const nickname = nicknameInput.value.trim();
            const phone = phoneInput.value.trim();
            if (!nickname || !phone) {
                alert('請務必填寫暱稱和電話！');
                return;
            }
            submitScoreBtn.disabled = true;
            submitScoreBtn.textContent = '上傳中...';
            try {
                logEvent(analytics, 'submit_score', { 
                    value: score,
                    player_nickname: nickname 
                });

                const docRef = await addDoc(leaderboardRef, {
                    nickname: nickname,
                    phone: phone,
                    score: score,
                    totalTime: totalTime, // **修改：儲存總耗時**
                    timestamp: serverTimestamp()
                });
                currentPlayerDocId = docRef.id;
                switchScreen('leaderboard');
                
                nicknameInput.value = '';
                phoneInput.value = '';
                submitScoreBtn.disabled = false;
                submitScoreBtn.textContent = '登錄成績';

            } catch (error) {
                console.error("寫入 Firestore 失敗:", error);
                alert("成績上傳失敗，請檢查網路或聯繫管理員。");
                submitScoreBtn.disabled = false;
                submitScoreBtn.textContent = '登錄成績';
            }
        }

        function setupLeaderboardListener() {
            const leaderboardList = document.getElementById('leaderboard-list');
            const leaderboardMessage = document.getElementById('leaderboard-message');
            const topPlayersList = document.getElementById('top-players-list');
            const topPlayersContainer = document.getElementById('top-players-container');

            // **修改：更新查詢排序邏輯**
            const q = query(leaderboardRef, orderBy("score", "desc"), orderBy("totalTime", "asc"), limit(20));
            
            onSnapshot(q, (querySnapshot) => {
                leaderboardList.innerHTML = '';
                topPlayersList.innerHTML = '';
                
                if (querySnapshot.empty) {
                    leaderboardMessage.textContent = '目前還沒有人挑戰成功，快來搶頭香！';
                    if (leaderboardList && !leaderboardList.contains(leaderboardMessage)) {
                        leaderboardList.appendChild(leaderboardMessage);
                    }
                    topPlayersContainer.classList.add('opacity-0');
                } else {
                    topPlayersContainer.classList.remove('opacity-0');
                    querySnapshot.docs.forEach((doc, index) => {
                        const player = doc.data();

                        // Populate the main leaderboard
                        const item = document.createElement('div');
                        item.classList.add('leaderboard-item', 'text-lg', 'sm:text-xl', 'border-t', 'border-gray-700');
                        if (index < 3) item.classList.add('font-bold', 'text-yellow-300');
                        if (doc.id === currentPlayerDocId) {
                            item.classList.add('highlight-me');
                            setTimeout(() => item.scrollIntoView({ behavior: 'smooth', block: 'center' }), 500);
                        }
                        item.innerHTML = `<span>#${index + 1}</span><span class="truncate">${player.nickname}</span><span class="text-right">${player.score}</span>`;
                        leaderboardList.appendChild(item);

                        // Populate the top 3 snippet on the start screen
                        if (index < 3) {
                            const topPlayerItem = document.createElement('div');
                            topPlayerItem.className = 'flex justify-between items-center text-lg';
                            topPlayerItem.innerHTML = `<span class="font-bold text-yellow-400">#${index + 1} ${player.nickname}</span> <span class="text-gray-300">${player.score}分</span>`;
                            topPlayersList.appendChild(topPlayerItem);
                        }
                    });
                }
            }, (error) => {
                console.error("監聽排行榜失敗:", error);
                leaderboardList.innerHTML = '';
                 if (leaderboardList && leaderboardMessage) {
                    leaderboardMessage.textContent = '讀取排行榜失敗。';
                    if (!leaderboardList.contains(leaderboardMessage)) leaderboardList.appendChild(leaderboardMessage);
                    
                    // **修改：提供更明確的索引建立提示**
                    if(error.code === 'failed-precondition') {
                        leaderboardMessage.innerHTML = '排行榜讀取失敗。<br><br><small>請依照 Console 中的錯誤訊息，點擊連結以建立 Firestore 索引。</small>';
                        // 在 Console 中印出完整的錯誤訊息和連結
                        console.error("Firestore 索引錯誤： Firestore 需要一個新的複合索引來完成這個查詢。請複製以下連結並在瀏覽器中開啟，以建立所需的索引：", error.message.substring(error.message.indexOf('https://')));
                    }
                }
            });
        }
        
        async function handleInteraction(callback) {
            if (Tone.context.state !== 'running') await Tone.start();
            playSound('click');
            callback();
        }

        startBtn.onclick = () => handleInteraction(() => {
            currentPlayerDocId = null;
            switchScreen('rules');
        });
        playBtn.onclick = () => handleInteraction(startGame);
        submitScoreBtn.onclick = () => handleInteraction(saveScore);
        leaderboardBtn.onclick = () => handleInteraction(() => {
             currentPlayerDocId = null;
             switchScreen('leaderboard');
        });
        closeLeaderboardBtn.onclick = () => handleInteraction(() => {
            currentPlayerDocId = null;
            switchScreen('start');
        });
        
        ['mousedown', 'mousemove', 'touchstart', 'keydown'].forEach(event => document.addEventListener(event, resetIdleTimer, true));

        // --- 動態背景 ---
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 1.5 + 0.5;
                this.speedX = (Math.random() * 0.5 - 0.25) * 0.5;
                this.speedY = (Math.random() * 0.5 - 0.25) * 0.5;
                this.opacity = Math.random() * 0.5 + 0.2;
            }
            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                if (this.x > canvas.width || this.x < 0) this.speedX *= -1;
                if (this.y > canvas.height || this.y < 0) this.speedY *= -1;
            }
            draw() {
                ctx.fillStyle = `rgba(255, 255, 255, ${this.opacity})`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function initParticles() {
            particles = [];
            let numberOfParticles = (canvas.width * canvas.height) / 9000;
            for (let i = 0; i < numberOfParticles; i++) {
                particles.push(new Particle());
            }
        }

        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let i = 0; i < particles.length; i++) {
                particles[i].update();
                particles[i].draw();
            }
            requestAnimationFrame(animateParticles);
        }

        window.addEventListener('resize', () => {
            resizeCanvas();
            initParticles();
        });

        resizeCanvas();
        initParticles();
        animateParticles();
        // --- 結束動態背景 ---

        setupLeaderboardListener();
        resetIdleTimer();

    </script>
</body>
</html>

